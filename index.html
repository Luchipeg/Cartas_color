 <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Collector</title>

<style>
body { font-family: system-ui; margin: 10px; }
#controls, #collections { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; }

#canvasContainer {
  position: relative;
  border:1px solid #ccc;
  touch-action: pan-y;
}

canvas {
  width:100%;
  height:auto;
  display:block;
}

#lupa {
  position:absolute;
  width:90px; height:90px;
  border-radius:50%;
  border:2px solid #000;
  overflow:hidden;
  display:none;
  pointer-events:none;
}

#lupaCanvas {
  width:30px; height:30px;
  transform:scale(3);
  transform-origin:top left;
}

#infoBox {
  position:absolute;
  background:white;
  border:1px solid #aaa;
  padding:6px;
  border-radius:6px;
  display:none;
  font-size:12px;
}

#colorPreview {
  width:30px; height:30px;
  border:1px solid #000;
  margin-bottom:4px;
}

#grid {
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:4px;
  margin-top:10px;
}

.colorCell {
  height:50px;
  font-size:9px;
  border:1px solid #888;
  text-align:center;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
</style>
</head>

<body>

<h3>Color Collector</h3>

<div id="controls">
  <input type="file" id="imgUpload">
  <button id="togglePick">Modo captura: OFF</button>
  <button id="calBlack">Calibrar negro</button>
  <button id="calWhite">Calibrar blanco</button>
</div>

<div id="collections">
  <input id="newCollection" placeholder="Nueva colección">
  <button id="addCollection">Crear</button>
  <select id="collectionSelect"></select>
</div>

<div id="canvasContainer">
  <canvas id="canvas"></canvas>

  <div id="lupa">
    <canvas id="lupaCanvas" width="30" height="30"></canvas>
  </div>

  <div id="infoBox">
    <div id="colorPreview"></div>
    <input id="colorName" placeholder="Número / nombre">
    <div id="hexLabel"></div>
    <button id="saveColor">Guardar</button>
  </div>
</div>

<div id="grid"></div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const lupa = document.getElementById('lupa');
const lupaCtx = document.getElementById('lupaCanvas').getContext('2d');
const infoBox = document.getElementById('infoBox');
const colorPreview = document.getElementById('colorPreview');
const colorName = document.getElementById('colorName');
const hexLabel = document.getElementById('hexLabel');
const grid = document.getElementById('grid');

let img = new Image();
let picking = false;
let currentColor = null;

let blackRef = 0;
let whiteRef = 255;

let collections = {};
let activeCollection = null;

// ---------- utils ----------
function rgbToHex(r,g,b){
  return "#" + ((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase();
}

function applyCalibration(v){
  return Math.min(255, Math.max(0, (v-blackRef)*(255/(whiteRef-blackRef))));
}

// ---------- image ----------
document.getElementById('imgUpload').onchange = e=>{
  img.src = URL.createObjectURL(e.target.files[0]);
};

img.onload = ()=>{
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  ctx.drawImage(img,0,0);
};

// ---------- toggle pick ----------
document.getElementById('togglePick').onclick=()=>{
  picking=!picking;
  canvas.style.pointerEvents = picking ? 'auto':'none';
  event.target.textContent = `Modo captura: ${picking?'ON':'OFF'}`;
};

// ---------- calibration ----------
document.getElementById('calBlack').onclick=()=>{
  if(currentColor) blackRef = currentColor.raw;
};

document.getElementById('calWhite').onclick=()=>{
  if(currentColor) whiteRef = currentColor.raw;
};

// ---------- touch ----------
canvas.addEventListener('touchstart', handleTouch);
canvas.addEventListener('touchmove', handleTouch);

function handleTouch(e){
  if(!picking) return;
  e.preventDefault();

  const t = e.touches[0];
  const r = canvas.getBoundingClientRect();
  const x = (t.clientX-r.left)*(canvas.width/r.width);
  const y = (t.clientY-r.top)*(canvas.height/r.height);

  const d = ctx.getImageData(x-1,y-1,2,2).data;
  let rr=(d[0]+d[4]+d[8]+d[12])/4;
  let gg=(d[1]+d[5]+d[9]+d[13])/4;
  let bb=(d[2]+d[6]+d[10]+d[14])/4;

  const raw = rr;
  rr = applyCalibration(rr)|0;
  gg = applyCalibration(gg)|0;
  bb = applyCalibration(bb)|0;

  const hex = rgbToHex(rr,gg,bb);
  currentColor = {hex, raw};

  lupa.style.display='block';
  lupa.style.left=(t.clientX-45)+'px';
  lupa.style.top=(t.clientY-100)+'px';
  lupaCtx.imageSmoothingEnabled=false;
  lupaCtx.drawImage(canvas,x-5,y-5,10,10,0,0,30,30);

  infoBox.style.display='block';
  infoBox.style.left=(t.clientX+10)+'px';
  infoBox.style.top=(t.clientY-10)+'px';

  colorPreview.style.background=hex;
  hexLabel.textContent=hex;
}

// ---------- collections ----------
document.getElementById('addCollection').onclick=()=>{
  const n=document.getElementById('newCollection').value.trim();
  if(!n) return;
  collections[n]=[];
  updateCollections();
};

function updateCollections(){
  const sel=document.getElementById('collectionSelect');
  sel.innerHTML='';
  Object.keys(collections).forEach(k=>{
    const o=document.createElement('option');
    o.textContent=k;
    sel.appendChild(o);
  });
  activeCollection=sel.value;
}

document.getElementById('collectionSelect').onchange=e=>{
  activeCollection=e.target.value;
  renderGrid();
};

// ---------- save ----------
document.getElementById('saveColor').onclick=()=>{
  if(!activeCollection||!currentColor||!colorName.value) return;
  collections[activeCollection].push({
    name: colorName.value,
    hex: currentColor.hex
  });
  colorName.value='';
  renderGrid();
};

// ---------- grid ----------
function renderGrid(){
  grid.innerHTML='';
  if(!activeCollection) return;
  collections[activeCollection].forEach(c=>{
    const d=document.createElement('div');
    d.className='colorCell';
    d.style.background=c.hex;
    d.innerHTML=`${c.name}<br>${c.hex}`;
    grid.appendChild(d);
  });
}
</script>

</body>
</html>

