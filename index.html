<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Colores</title>
<style>
  body { font-family: sans-serif; margin: 10px; }
  #canvasContainer { position: relative; display: inline-block; border: 1px solid #ccc; }
  canvas { max-width: 100%; height: auto; display: block; }
  #colorBox { width: 30px; height: 30px; display: inline-block; vertical-align: middle; margin-left: 10px; border: 1px solid #000; }
  #colorNameInput { width: 100px; }
  #controls { margin-top: 10px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  .palette { display: flex; margin-top: 5px; }
  .palette div { width: 40px; height: 40px; margin-right: 2px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #000; }
</style>
</head>
<body>

<h2>Gestor de Colores</h2>

<input type="file" id="imageLoader" accept="image/png, image/jpeg"><br>
<div id="canvasContainer">
  <canvas id="imageCanvas"></canvas>
</div>

<div id="colorInfo">
  <input type="text" id="colorNameInput" placeholder="Número/Nombre">
  <div id="colorBox"></div>
  <button id="saveColor">Guardar color</button>
</div>

<div id="collections">
  <input type="text" id="collectionName" placeholder="Nombre colección">
  <button id="createCollection">Crear colección</button>
  <select id="collectionSelect"></select>
</div>

<div id="sorting">
  <button data-sort="h">Matiz</button>
  <button data-sort="hs">Matiz + Claro-Oscuro</button>
  <button data-sort="s">Saturación</button>
  <button data-sort="l">Luminosidad</button>
</div>

<div id="export">
  <button id="exportNames">Exportar Número/Nombre</button>
  <button id="exportHex">Exportar Número/Nombre + HEX</button>
</div>

<table id="colorsTable">
  <thead>
    <tr>
      <th>Colección</th>
      <th>Número/Nombre</th>
      <th>HEX</th>
      <th>Color</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="palettes"></div>

<script>
let canvas = document.getElementById('imageCanvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let currentColor = '#ffffff';
let colors = [];
let collections = {};
let currentCollection = '';

document.getElementById('imageLoader').addEventListener('change', function(e){
  let reader = new FileReader();
  reader.onload = function(event){
    img.onload = function(){
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
    }
    img.src = event.target.result;
  }
  reader.readAsDataURL(e.target.files[0]);
});

canvas.addEventListener('click', function(e){
  let rect = canvas.getBoundingClientRect();
  let x = Math.floor(e.clientX - rect.left);
  let y = Math.floor(e.clientY - rect.top);
  // solo promedia 4 píxeles
  let imageData = ctx.getImageData(x, y, 2, 2).data;
  let r = Math.round((imageData[0]+imageData[4]+imageData[8]+imageData[12])/4);
  let g = Math.round((imageData[1]+imageData[5]+imageData[9]+imageData[13])/4);
  let b = Math.round((imageData[2]+imageData[6]+imageData[10]+imageData[14])/4);
  currentColor = rgbToHex(r,g,b);
  document.getElementById('colorBox').style.backgroundColor = currentColor;
});

document.getElementById('saveColor').addEventListener('click', function(){
  let name = document.getElementById('colorNameInput').value.trim();
  if(!name || !currentCollection) { alert('Introduce nombre y selecciona colección'); return; }
  let hsl = hexToHSL(currentColor);
  let entry = {collection: currentCollection, name, hex: currentColor, ...hsl};
  colors.push(entry);
  updateTable();
  generatePalettes(currentCollection);
});

document.getElementById('createCollection').addEventListener('click', function(){
  let cname = document.getElementById('collectionName').value.trim();
  if(!cname) return;
  if(!collections[cname]) collections[cname] = [];
  currentCollection = cname;
  updateCollectionSelect();
});

document.getElementById('collectionSelect').addEventListener('change', function(){
  currentCollection = this.value;
  generatePalettes(currentCollection);
});

document.querySelectorAll('#sorting button').forEach(btn=>{
  btn.addEventListener('click', function(){
    let type = this.dataset.sort;
    sortColors(type);
    updateTable();
  });
});

document.getElementById('exportNames').addEventListener('click', function(){
  exportColors(false);
});
document.getElementById('exportHex').addEventListener('click', function(){
  exportColors(true);
});

function updateCollectionSelect(){
  let sel = document.getElementById('collectionSelect');
  sel.innerHTML = '';
  for(let c in collections){
    let opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  }
  sel.value = currentCollection;
}

function updateTable(){
  let tbody = document.querySelector('#colorsTable tbody');
  tbody.innerHTML = '';
  colors.filter(c=>c.collection===currentCollection).forEach(c=>{
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.collection}</td><td>${c.name}</td><td>${c.hex}</td><td style="background:${c.hex}"></td>`;
    tbody.appendChild(tr);
  });
}

function generatePalettes(collection){
  let container = document.getElementById('palettes');
  container.innerHTML = '';
  let col = colors.filter(c=>c.collection===collection);
  col.forEach(c=>{
    let div = document.createElement('div');
    div.className = 'palette';
    for(let i=0;i<5;i++){
      let p = document.createElement('div');
      let colorIndex = (col.indexOf(c)+i)%col.length;
      p.style.background = col[colorIndex].hex;
      p.textContent = col[colorIndex].name;
      div.appendChild(p);
    }
    container.appendChild(div);
  });
}

// helpers
function rgbToHex(r,g,b){return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');}
function hexToHSL(H){
  let r=parseInt(H.substr(1,2),16)/255;
  let g=parseInt(H.substr(3,2),16)/255;
  let b=parseInt(H.substr(5,2),16)/255;
  let max=Math.max(r,g,b),min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max==min){h=s=0;}else{
    let d=max-min;
    s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){case r: h=(g-b)/d + (g<b?6:0); break; case g: h=(b-r)/d +2; break; case b: h=(r-g)/d +4; break;}
    h=Math.round(h*360);
    s=Math.round(s*100);
    l=Math.round(l*100);
  }
  return {h,s,l};
}

function sortColors(type){
  let arr = colors.filter(c=>c.collection===currentCollection);
  switch(type){
    case 'h': arr.sort((a,b)=>a.h-b.h); break;
    case 'hs': arr.sort((a,b)=>a.h-b.h || a.l-b.l); break;
    case 's': arr.sort((a,b)=>a.s-b.s); break;
    case 'l': arr.sort((a,b)=>a.l-b.l); break;
  }
  colors = colors.filter(c=>c.collection!==currentCollection).concat(arr);
}

function exportColors(withHex){
  let col = colors.filter(c=>c.collection===currentCollection);
  let text = col.map(c=>withHex?`${c.name} ${c.hex}`:c.name).join('\n');
  let blob = new Blob([text],{type:'text/plain'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `colores_${currentCollection}.txt`;
  a.click();
}
</script>

</body>
</html>
