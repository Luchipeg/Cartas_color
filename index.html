 <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartas de Color Deluxe</title>
<style>
  body { font-family: sans-serif; padding: 10px; }
  h1 { text-align:center; }
  #canvas-container { position: relative; display: inline-block; border:1px solid #ccc; margin-bottom:10px; }
  canvas { max-width: 100%; display:block; }
  #lupa { position:absolute; border:2px solid #000; width:80px; height:80px; border-radius:50%; overflow:hidden; display:none; pointer-events:none; }
  #color-box { width:30px; height:30px; display:inline-block; border:1px solid #000; vertical-align:middle; margin-left:5px; }
  #name-input { width: 80px; vertical-align:middle; margin-left:5px; }
  button { margin:2px; }
  #tabla-colores { display:grid; grid-template-columns: repeat(10, 1fr); gap:5px; margin-top:10px; }
  .color-cell { width:100%; padding-top:100%; position:relative; }
  .color-cell div { position:absolute; top:0; left:0; right:0; bottom:0; text-align:center; font-size:10px; color:#000; display:flex; flex-direction:column; justify-content:center; align-items:center; border:1px solid #ccc; box-sizing:border-box; }
</style>
</head>
<body>
<h1>Cartas de Color Deluxe</h1>

<input type="file" id="imgLoader" accept="image/png, image/jpeg">
<div id="canvas-container">
  <canvas id="canvas"></canvas>
  <div id="lupa"><canvas id="lupa-canvas" width="80" height="80"></canvas></div>
</div>
<input type="text" id="name-input" placeholder="Número/Nombre">
<div id="color-box"></div>
<button id="guardar-color">Guardar color</button>
<button id="ordenar-matiz">Ordenar por matiz</button>
<button id="ordenar-saturacion">Ordenar por saturación</button>
<button id="ordenar-luminosidad">Ordenar por luminosidad</button>
<button id="calibrar-negro">Calibrar negro</button>
<button id="calibrar-blanco">Calibrar blanco</button>
<button id="exportar">Exportar</button>

<div id="tabla-colores"></div>

<script>
// Variables globales
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let lupa = document.getElementById('lupa');
let lupaCanvas = document.getElementById('lupa-canvas');
let lupaCtx = lupaCanvas.getContext('2d');
let colorBox = document.getElementById('color-box');
let nameInput = document.getElementById('name-input');
let tabla = document.getElementById('tabla-colores');

let img = new Image();
let colores = [];
let calibracion = { negro:null, blanco:null };

// Cargar imagen
document.getElementById('imgLoader').addEventListener('change', function(e){
  let reader = new FileReader();
  reader.onload = function(event){
    img.onload = function(){
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
    }
    img.src = event.target.result;
  }
  reader.readAsDataURL(e.target.files[0]);
});

// Función HSL
function hexToHSL(H) {
  let r = parseInt(H.substring(1,3),16)/255;
  let g = parseInt(H.substring(3,5),16)/255;
  let b = parseInt(H.substring(5,7),16)/255;
  let max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h,s,l = (max + min)/2;

  if(max==min){h=s=0;}
  else{
    let d = max - min;
    s = l>0.5? d/(2 - max - min) : d/(max + min);
    switch(max){
      case r: h = (g - b)/d + (g<b?6:0); break;
      case g: h = (b - r)/d + 2; break;
      case b: h = (r - g)/d + 4; break;
    }
    h /= 6;
  }
  return {h:h*360, s:s*100, l:l*100};
}

// Obtener color de píxel (promediando max 4 píxeles)
function getColor(x,y){
  let imgData = ctx.getImageData(x,y,2,2).data;
  let r = 0,g=0,b=0,n=0;
  for(let i=0;i<imgData.length;i+=4){
    r+=imgData[i]; g+=imgData[i+1]; b+=imgData[i+2]; n++;
  }
  r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
  return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

// Mostrar lupa y actualizar color
canvas.addEventListener('mousemove',function(e){
  let rect = canvas.getBoundingClientRect();
  let x = Math.floor(e.clientX - rect.left);
  let y = Math.floor(e.clientY - rect.top);

  // Lupa
  lupa.style.display='block';
  let lupaX = e.clientX - rect.left - 40;
  let lupaY = e.clientY - rect.top - 40;
  lupa.style.left = lupaX + 'px';
  lupa.style.top = lupaY + 'px';
  lupaCtx.clearRect(0,0,80,80);
  lupaCtx.drawImage(canvas, x-2, y-2,4,4,0,0,80,80);

  // Color box
  let c = getColor(x,y);
  colorBox.style.background = c;

  // Guardar el último color seleccionado
  colorBox.dataset.color = c;
});

// Al salir del canvas ocultar lupa
canvas.addEventListener('mouseleave',function(){ lupa.style.display='none'; });

// Guardar color
document.getElementById('guardar-color').addEventListener('click',function(){
  let c = colorBox.dataset.color;
  let nombre = nameInput.value.trim();
  if(!c || !nombre) return;
  let hsl = hexToHSL(c);
  colores.push({nombre, hex:c, h:hsl.h, s:hsl.s, l:hsl.l});
  name
