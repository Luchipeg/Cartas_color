<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Collector Pro</title>
<style>
body { font-family:sans-serif; margin:0; padding:10px; display:flex; flex-direction:column; align-items:center; }
h3 { margin:10px; }
#canvasContainer { position: relative; margin:10px; touch-action:none; }
canvas { border:1px solid #333; max-width:95vw; height:auto; display:block; }
#colorPreview { width:40px; height:40px; border:1px solid #000; display:inline-block; vertical-align:middle; margin-left:10px; }
#colorInput { width:80px; vertical-align:middle; margin-left:10px; }
#saveColor { margin-left:10px; }
#controls { margin:10px; display:flex; flex-wrap:wrap; gap:5px; }
#colorTable { border-collapse: collapse; margin:10px; width:95%; max-width:800px;}
#colorTable th, #colorTable td { border:1px solid #ccc; padding:4px; text-align:center; }
.paleta { display:flex; gap:5px; flex-wrap:wrap; margin:5px 0;}
.paleta div { width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:10px; color:#000; border:1px solid #000; text-align:center; flex-direction:column;}
button.small { font-size:12px; padding:2px 4px;}
</style>
</head>
<body>
<h3>Color Collector Pro</h3>

<div id="canvasContainer">
<input type="file" id="imageLoader" accept="image/png, image/jpeg">
<canvas id="colorCanvas"></canvas>
</div>

<div>
<input type="text" id="colorInput" placeholder="Número/Nombre">
<div id="colorPreview"></div>
<button id="saveColor">Guardar color</button>
</div>

<div id="controls">
<button id="exportNames">Exportar nombres</button>
<button id="exportHex">Exportar nombres + HEX</button>
<button id="calBlack">Calibrar negro</button>
<button id="calWhite">Calibrar blanco</button>
<button id="sortHue" class="small">Ordenar por matiz</button>
<button id="sortSat" class="small">Ordenar por saturación</button>
<button id="sortLum" class="small">Ordenar por luminosidad</button>
<button id="sortHueLum" class="small">Matiz + Lum</button>
<button id="sortSatLum" class="small">Sat + Lum</button>
</div>

<h4>Paletas del color seleccionado:</h4>
<div id="paletas"></div>

<table id="colorTable">
<thead>
<tr><th>Número/Nombre</th><th>HEX</th><th>Color</th></tr>
</thead>
<tbody></tbody>
</table>

<script>
let canvas = document.getElementById('colorCanvas');
let ctx = canvas.getContext('2d');
let imageLoader = document.getElementById('imageLoader');
let colorInput = document.getElementById('colorInput');
let colorPreview = document.getElementById('colorPreview');
let saveColorBtn = document.getElementById('saveColor');
let colorTable = document.getElementById('colorTable').getElementsByTagName('tbody')[0];
let paletasDiv = document.getElementById('paletas');
let colors = [];
let blackCal = null, whiteCal = null;

// Cargar imagen
imageLoader.addEventListener('change', handleImage, false);
function handleImage(e){
    let reader = new FileReader();
    reader.onload = function(event){
        let img = new Image();
        img.onload = function(){
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
}

// Seleccionar color con lupa 2x2 px
canvas.addEventListener('click', function(e){
    let rect = canvas.getBoundingClientRect();
    let x = Math.floor(e.clientX - rect.left);
    let y = Math.floor(e.clientY - rect.top);
    let px = ctx.getImageData(x,y,2,2).data;
    let r = Math.round((px[0]+px[4]+px[8]+px[12])/4);
    let g = Math.round((px[1]+px[5]+px[9]+px[13])/4);
    let b = Math.round((px[2]+px[6]+px[10]+px[14])/4);

    // Aplicar calibración si existe
    if(blackCal) { r = calibrate(r, blackCal.r, 0); g = calibrate(g, blackCal.g,0); b = calibrate(b, blackCal.b,0); }
    if(whiteCal) { r = calibrate(r, whiteCal.r,255); g = calibrate(g, whiteCal.g,255); b = calibrate(b, whiteCal.b,255); }

    let hex = rgbToHex(r,g,b);
    colorPreview.style.backgroundColor = hex;
    colorInput.dataset.hex = hex;

    generatePaletas(hex); // Genera paletas de este color
});

// Guardar color
saveColorBtn.addEventListener('click', function(){
    if(!colorInput.value) return alert("Introduce nombre/número");
    let hex = colorInput.dataset.hex;
    if(!hex) return alert("Selecciona un color en la imagen primero");
    let name = colorInput.value;
    colors.push({name, hex, hsl: rgbToHslHex(hex)});
    updateTable();
    colorInput.value = '';
});

// Actualizar tabla
function updateTable(){
    colorTable.innerHTML = '';
    colors.forEach(c=>{
        let row = colorTable.insertRow();
        row.insertCell(0).innerText = c.name;
        row.insertCell(1).innerText = c.hex;
        let colorCell = row.insertCell(2);
        colorCell.style.backgroundColor = c.hex;
        colorCell.style.width = '30px';
    });
}

// Convertir RGB a HEX
function rgbToHex(r,g,b){ return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join(''); }

// Calibración negro/blanco
function calibrate(value, orig, target){ 
    return Math.min(255, Math.max(0, Math.round((value - orig)*(255-0)/(target-orig)))); 
}
document.getElementById('calBlack').addEventListener('click', ()=>{
    blackCal = {r:0,g:0,b:0};
    alert("Toca un punto negro en la imagen para calibrar");
    canvas.onclick = function(e){
        let rect = canvas.getBoundingClientRect();
        let x = Math.floor(e.clientX - rect.left);
        let y = Math.floor(e.clientY - rect.top);
        let px = ctx.getImageData(x,y,2,2).data;
        blackCal = {r:px[0],g:px[1],b:px[2]};
        alert("Negro calibrado");
        canvas.onclick = selectColor; // volver a función normal
    }
});
document.getElementById('calWhite').addEventListener('click', ()=>{
    whiteCal = {r:0,g:0,b:0};
    alert("Toca un punto blanco en la imagen para calibrar");
    canvas.onclick = function(e){
        let rect = canvas.getBoundingClientRect();
        let x = Math.floor(e.clientX - rect.left);
        let y = Math.floor(e.clientY - rect.top);
        let px = ctx.getImageData(x,y,2,2).data;
        whiteCal = {r:px[0],g:px[1],b:px[2]};
        alert("Blanco calibrado");
        canvas.onclick = selectColor;
    }
});

// Función de selección de color normal
function selectColor(e){
    let rect = canvas.getBoundingClientRect();
    let x = Math.floor(e.clientX - rect.left);
    let y = Math.floor(e.clientY - rect.top);
    let px = ctx.getImageData(x,y,2,2).data;
    let r = Math.round((px[0]+px[4]+px[8]+px[12])/4);
    let g = Math.round((px[1]+px[5]+px[9]+px[13])/4);
    let b = Math.round((px[2]+px[6]+px[10]+px[14])/4);
    if(blackCal) { r = calibrate(r, blackCal.r, 0); g = calibrate(g, blackCal.g,0); b = calibrate(b, blackCal.b,0); }
    if(whiteCal) { r = calibrate(r, whiteCal.r,255); g = calibrate(g, whiteCal.g,255); b = calibrate(b, whiteCal.b,255); }
    let hex = rgbToHex(r,g,b);
    colorPreview.style.backgroundColor = hex;
    colorInput.dataset.hex = hex;
    generatePaletas(hex);
}

// Convertir HEX a HSL
function rgbToHslHex(hex){
    let r=parseInt(hex.substr(1,2),16)/255;
    let g=parseInt(hex.substr(3,2),16)/255;
    let b=parseInt(hex.substr(5,2),16)/255;
    let max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max==min) h=s=0;
    else{
        let d=max-min;
        s=l>0.5? d/(2-max-min) : d/(max+min);
        switch(max){
            case r: h=(g-b)/d + (g<b?6:0); break;
            case g: h=(b-r)/d +2; break;
            case b: h=(r-g)/d +4; break;
        }
        h*=60;
    }
    return {h,s,l};
}

// Ordenación
function sortColors(criteria){
    colors.sort((a,b)=>{
        if(criteria=='hue') return a.hsl.h - b.hsl.h;
        if(criteria=='sat') return a.hsl.s - b.hsl.s;
        if(criteria=='lum') return a.hsl.l - b.hsl.l;
        if(criteria=='hueLum') return (a.hsl.h - b.hsl.h)|| (a.hsl.l - b.hsl.l);
        if(criteria=='satLum') return (a.hsl.s - b.hsl.s)|| (a.hsl.l - b.hsl.l);
    });
    updateTable();
}

document.getElementById('sortHue').onclick=()=>sortColors('hue');
document.getElementById('sortSat').onclick=()=>sortColors('sat');
document.getElementById('sortLum').onclick=()=>sortColors('lum');
document.getElementById('sortHueLum').onclick=()=>sortColors('hueLum');
document.getElementById('sortSatLum').onclick=()=>sortColors('satLum');

// Exportar
document.getElementById('exportNames').addEventListener('click',()=>{
    if(colors.length===0) return alert("No hay colores guardados");
    let text = colors.map(c=>c.name).join('\n');
    downloadText(text,'colors_names.txt');
});
document.getElementById('exportHex').addEventListener('click',()=>{
    if(colors.length===0) return alert("No hay colores guardados");
    let text = colors.map(c=>c.name + ' - ' + c.hex).join('\n');
    downloadText(text,'colors_names_hex.txt');
});
function downloadText(text, filename){
    let blob = new Blob([text], {type:'text/plain'});
    let link = document.createElement('a');
    link.download = filename;
    link.href = window.URL.createObjectURL(blob);
    link.click();
}

// Generar paletas simples de colores existentes
function generatePaletas(hex){
    paletasDiv.innerHTML='';
    let baseColor = colors.find(c=>c.hex===hex);
    if(!baseColor) return;
    for(let i=0;i<4;i++){
        let divPaleta = document.createElement('div');
        divPaleta.className='paleta';
        let shuffled = colors.sort(()=>0.5-Math.random()).slice(0,5);
        shuffled.forEach(c=>{
            let d = document.createElement('div');
            d.style.backgroundColor=c.hex;
            d.innerHTML=c.name + '<br>' + c.hex;
            divPaleta.appendChild(d);
        });
        paletasDiv.appendChild(divPaleta);
    }
}
</script>
</body>
</html> 

