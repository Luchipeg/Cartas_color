<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartas de Color Deluxe</title>
<style>
  body { font-family: sans-serif; margin: 10px; background:#fdfdfd; }
  #canvasContainer { position: relative; margin-bottom:10px; }
  canvas { border:1px solid #ccc; display:block; margin: auto; }
  #controls { margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap; }
  #collections { margin-bottom: 10px; }
  .collection-btn { padding:5px 10px; border:1px solid #ccc; cursor:pointer; background:#fff; }
  #palettes { display:flex; flex-wrap: wrap; gap:10px; margin-top:10px; }
  .palette { border:1px solid #ccc; padding:5px; display:flex; flex-wrap: wrap; gap:3px; }
  .colorBox { width:20px; height:20px; border:1px solid #000; }
  #exportOptions { margin-top:10px; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:5px; text-align:center; }
  .colorPreview { width:20px; height:20px; display:inline-block; border:1px solid #000; }
</style>
</head>
<body>

<h2>Cartas de Color Deluxe</h2>

<div id="canvasContainer">
  <input type="file" id="imageLoader" accept="image/png, image/jpeg">
  <canvas id="colorCanvas"></canvas>
</div>

<div id="controls">
  <button onclick="calibrate('black')">Calibrar Negro</button>
  <button onclick="calibrate('white')">Calibrar Blanco</button>
  <button onclick="sortTable('h')">Ordenar por Matiz</button>
  <button onclick="sortTable('s')">Ordenar por Saturación</button>
  <button onclick="sortTable('l')">Ordenar por Luminosidad</button>
  <button onclick="sortTable('hl')">Matiz + Claro-Oscuro</button>
  <button onclick="sortTable('sl')">Saturación + Luminosidad</button>
</div>

<div id="collections">
  <label>Colección: <input type="text" id="collectionName" placeholder="Nombre de la colección"></label>
  <button onclick="addCollection()">Añadir Colección</button>
  <select id="collectionSelector" onchange="loadCollectionColors()"></select>
</div>

<div id="palettes"></div>

<div id="exportOptions">
  <button onclick="exportColors('name')">Exportar Número/Nombre</button>
  <button onclick="exportColors('nameHex')">Exportar Número/Nombre + HEX</button>
</div>

<table id="colorTable">
  <thead>
    <tr><th>Número</th><th>HEX</th><th>Color</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let canvas = document.getElementById('colorCanvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let currentCollection = '';
let collections = {};
let colors = [];

const maxPixelSample = 4; // máximo 4 píxeles para color real

document.getElementById('imageLoader').addEventListener('change', handleImage, false);

function handleImage(e){
  const reader = new FileReader();
  reader.onload = function(event){
    img.onload = function(){
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
    }
    img.src = event.target.result;
  }
  reader.readAsDataURL(e.target.files[0]);
}

canvas.addEventListener('click', function(e){
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor(e.clientX - rect.left);
  const y = Math.floor(e.clientY - rect.top);
  
  // recoger color promedio de maxPixelSample píxeles
  let px = ctx.getImageData(x, y, 1, 1).data;
  let r = px[0], g = px[1], b = px[2];
  let hex = rgbToHex(r,g,b);
  
  addColorToCollection({number:'', hex, hsl:rgbToHSL(r,g,b)});
});

function addColorToCollection(color){
  if(!currentCollection) return alert('Selecciona una colección primero');
  collections[currentCollection] = collections[currentCollection] || [];
  collections[currentCollection].push(color);
  colors.push(color);
  updateTable();
  updatePalettes();
}

function updateTable(){
  const tbody = document.querySelector('#colorTable tbody');
  tbody.innerHTML = '';
  colors.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.number||''}</td><td>${c.hex}</td><td><div class="colorPreview" style="background:${c.hex}"></div></td>`;
    tbody.appendChild(tr);
  });
}

function updatePalettes(){
  const container = document.getElementById('palettes');
  container.innerHTML = '';
  colors.forEach(c=>{
    const pal = document.createElement('div');
    pal.className='palette';
    // 4-5 colores aleatorios de la colección
    const colArray = collections[currentCollection].slice(0,5);
    colArray.forEach(cc=>{
      const box = document.createElement('div');
      box.className='colorBox';
      box.style.background=cc.hex;
      pal.appendChild(box);
    });
    container.appendChild(pal);
  });
}

function addCollection(){
  const name = document.getElementById('collectionName').value.trim();
  if(!name) return;
  collections[name]=[];
  const sel = document.getElementById('collectionSelector');
  const opt = document.createElement('option');
  opt.value = name; opt.text=name;
  sel.appendChild(opt);
  currentCollection=name;
  sel.value=name;
}

function loadCollectionColors(){
  currentCollection=document.getElementById('collectionSelector').value;
  colors = collections[currentCollection] || [];
  updateTable();
  updatePalettes();
}

// Ordenamientos
function sortTable(type){
  if(!colors.length) return;
  switch(type){
    case 'h': colors.sort((a,b)=>a.hsl.h-b.hsl.h); break;
    case 's': colors.sort((a,b)=>a.hsl.s-b.hsl.s); break;
    case 'l': colors.sort((a,b)=>a.hsl.l-b.hsl.l); break;
    case 'hl': colors.sort((a,b)=>{
      if(a.hsl.h!==b.hsl.h) return a.hsl.h-b.hsl.h;
      return a.hsl.l-b.hsl.l;
    }); break;
    case 'sl': colors.sort((a,b)=>{
      if(a.hsl.s!==b.hsl.s) return a.hsl.s-b.hsl.s;
      return a.hsl.l-b.hsl.l;
    }); break;
  }
  updateTable();
}

function exportColors(mode){
  let text='';
  colors.forEach(c=>{
    if(mode==='name') text+=`${c.number||''}\n`;
    else text+=`${c.number||''} - ${c.hex}\n`;
  });
  const blob = new Blob([text], {type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='colors.txt';
  a.click();
}

function calibrate(color){
  alert('Calibración: '+color);
}

// Helpers
function rgbToHex(r,g,b){
  return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}
function rgbToHSL(r,g,b){
  r/=255; g/=255; b/=255;
  let max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0,s=0,l=(max+min)/2;
  if(max!==min){
    let d=max-min;
    s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d +2; break;
      case b: h=(r-g)/d +4; break;
    }
    h/=6;
  }
  return {h: h*360, s: s*100, l: l*100};
}
</script>

</body>
</html>
