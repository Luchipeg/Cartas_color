<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Collector Base Estable + Añadidos</title>
<style>
body { font-family: sans-serif; margin:0; padding:10px; display:flex; flex-direction:column; align-items:center;}
h3 { margin:10px;}
#canvasContainer { position: relative; margin:10px; touch-action:none; }
canvas { border:1px solid #333; max-width:95vw; height:auto; display:block; }
#colorPreview { width:40px; height:40px; border:1px solid #000; display:inline-block; vertical-align:middle; margin-left:10px; }
#colorInput { width:80px; vertical-align:middle; margin-left:10px; }
#controls { margin:10px; display:flex; gap:5px; flex-wrap:wrap;}
#colorTable { border-collapse: collapse; margin:10px; width:95%; max-width:800px;}
#colorTable th, #colorTable td { border:1px solid #ccc; padding:4px; text-align:center; }
#saveColor { margin-left:10px; }

#collectionSelect, #createCollection, #palettesContainer, #calibrationControls {
  margin:10px;
  display:flex;
  gap:5px;
  flex-wrap:wrap;
}

.palettes { display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;}
.paletteColor { width:30px; height:30px; border:1px solid #000;}
</style>
</head>
<body>
<h3>Color Collector Base Estable + Añadidos</h3>

<div id="canvasContainer">
<input type="file" id="imageLoader" accept="image/png, image/jpeg">
<canvas id="colorCanvas"></canvas>
</div>

<div>
<input type="text" id="colorInput" placeholder="Número/Nombre">
<div id="colorPreview"></div>
<button id="saveColor">Guardar color</button>
</div>

<div id="controls">
<button id="exportNames">Exportar nombres/números</button>
<button id="exportHex">Exportar nombres/números + HEX</button>
</div>

<!-- NUEVAS FUNCIONES -->
<div id="collectionControls">
<select id="collectionSelect">
  <option value="">Seleccionar colección</option>
</select>
<input type="text" id="createCollection" placeholder="Nueva colección">
<button id="addCollection">Añadir colección</button>
</div>

<div id="calibrationControls">
<button id="calibrateBlack">Calibrar Negro</button>
<button id="calibrateWhite">Calibrar Blanco</button>
</div>

<div id="palettesContainer">
<h4>Paletas</h4>
<div class="palettes" id="palettesDisplay"></div>
</div>

<table id="colorTable">
<thead>
<tr><th>Número/Nombre</th><th>HEX</th><th>Color</th></tr>
</thead>
<tbody>
</tbody>
</table>

<script>
// === TU CÓDIGO ORIGINAL ===
let canvas = document.getElementById('colorCanvas');
let ctx = canvas.getContext('2d');
let imageLoader = document.getElementById('imageLoader');
let colorInput = document.getElementById('colorInput');
let colorPreview = document.getElementById('colorPreview');
let saveColorBtn = document.getElementById('saveColor');
let colorTable = document.getElementById('colorTable').getElementsByTagName('tbody')[0];
let colors = [];

imageLoader.addEventListener('change', handleImage, false);

function handleImage(e){
    let reader = new FileReader();
    reader.onload = function(event){
        let img = new Image();
        img.onload = function(){
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
}

canvas.addEventListener('click', function(e){
    let rect = canvas.getBoundingClientRect();
    let x = Math.floor(e.clientX - rect.left);
    let y = Math.floor(e.clientY - rect.top);
    let px = ctx.getImageData(x,y,2,2).data;
    let r = Math.round((px[0]+px[4]+px[8]+px[12])/4);
    let g = Math.round((px[1]+px[5]+px[9]+px[13])/4);
    let b = Math.round((px[2]+px[6]+px[10]+px[14])/4);
    let hex = rgbToHex(r,g,b);
    colorPreview.style.backgroundColor = hex;
    colorInput.dataset.hex = hex;
});

saveColorBtn.addEventListener('click', function(){
    if(!colorInput.value) return alert("Introduce nombre/número");
    let hex = colorInput.dataset.hex;
    if(!hex) return alert("Selecciona un color en la imagen primero");
    let name = colorInput.value;
    let collection = collectionSelect.value || 'Default';
    if(!collections[collection]) collections[collection] = [];
    collections[collection].push({name, hex});
    colors.push({name, hex, collection});
    updateTable();
    updatePalettes();
    colorInput.value = '';
});

function updateTable(){
    colorTable.innerHTML = '';
    colors.forEach(c=>{
        let row = colorTable.insertRow();
        row.insertCell(0).innerText = c.name;
        row.insertCell(1).innerText = c.hex;
        let colorCell = row.insertCell(2);
        colorCell.style.backgroundColor = c.hex;
        colorCell.style.width = '30px';
    });
}

function rgbToHex(r,g,b){
    return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}

document.getElementById('exportNames').addEventListener('click',()=>{
    if(colors.length===0) return alert("No hay colores guardados");
    let text = colors.map(c=>c.name).join('\n');
    downloadText(text,'colors_names.txt');
});  

document.getElementById('exportHex').addEventListener('click',()=>{
    if(colors.length===0) return alert("No hay colores guardados");
    let text = colors.map(c=>c.name + ' - ' + c.hex).join('\n');
    downloadText(text,'colors_names_hex.txt');
});

function downloadText(text, filename){
    let blob = new Blob([text], {type:'text/plain'});
    let link = document.createElement('a');
    link.download = filename;
    link.href = window.URL.createObjectURL(blob);
    link.click();
}

// === NUEVAS FUNCIONES ===

// Colecciones
let collections = {};
let collectionSelect = document.getElementById('collectionSelect');
document.getElementById('addCollection').addEventListener('click',()=>{
    let name = document.getElementById('createCollection').value.trim();
    if(!name) return;
    if(!collections[name]) collections[name] = [];
    let opt = document.createElement('option');
    opt.value = name;
    opt.text = name;
    collectionSelect.appendChild(opt);
    document.getElementById('createCollection').value = '';
});

// Calibraciones
document.getElementById('calibrateBlack').addEventListener('click',()=>{
    alert("Calibración negra aplicada (simulada)");
});
document.getElementById('calibrateWhite').addEventListener('click',()=>{
    alert("Calibración blanca aplicada (simulada)");
});

// Paletas
let palettesDisplay = document.getElementById('palettesDisplay');
function updatePalettes(){
    palettesDisplay.innerHTML = '';
    let collection = collectionSelect.value || 'Default';
    if(!collections[collection]) return;
    collections[collection].forEach(c=>{
        let div = document.createElement('div');
        div.classList.add('paletteColor');
        div.style.backgroundColor = c.hex;
        div.title = c.name + ' - ' + c.hex;
        palettesDisplay.appendChild(div);
    });
}
</script>
</body>
</html>
