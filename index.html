 <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Collector Deluxe</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { text-align: center; }
#canvasContainer { position: relative; display: inline-block; border: 1px solid #ccc; margin-bottom: 10px; }
canvas { max-width: 100%; height: auto; }
#lupa {
  position: absolute; border: 2px solid #000; border-radius: 50%;
  width: 80px; height: 80px; overflow: hidden; display: none; pointer-events: none;
}
#lupaCanvas { width: 80px; height: 80px; transform: scale(4); transform-origin: top left; }
#colorBox { width: 40px; height: 40px; display: inline-block; vertical-align: middle; border:1px solid #000; margin-left: 10px; }
#nameInput { width: 100px; margin-left:10px; }
#saveBtn { margin-left:10px; }
#controls { margin-bottom:10px; }
#collectionSelect { margin-right:10px; }
#grid { display: grid; grid-template-columns: repeat(10, 50px); grid-gap:5px; margin-top:10px; }
.colorCell { width:50px; height:50px; position:relative; cursor:pointer; border:1px solid #ccc; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:10px; text-align:center; word-break:break-word; }
.colorCell button { position:absolute; top:0; right:0; font-size:10px; }
#exportBtn { margin-top:10px; }
</style>
</head>
<body>

<h1>Color Collector Deluxe</h1>

<div id="controls">
  <input type="file" id="imgUpload" accept="image/png, image/jpeg">
  <select id="collectionSelect"></select>
  <button id="newCollectionBtn">Nueva Colección</button>
  <select id="sortSelect">
    <option value="h_l">Matiz exacto → Claro-Oscuro</option>
    <option value="approx_h_l">Matiz aproximado → Claro-Oscuro</option>
    <option value="s_l">Saturación → Luminosidad</option>
    <option value="l_s">Luminosidad → Saturación</option>
  </select>
</div>

<div id="canvasContainer">
  <canvas id="mainCanvas"></canvas>
  <div id="lupa">
    <canvas id="lupaCanvas" width="20" height="20"></canvas>
  </div>
  <input type="text" id="nameInput" placeholder="Número/Nombre" style="position:absolute; display:none;">
  <div id="colorBox" style="position:absolute; display:none;"></div>
  <button id="saveBtn" style="position:absolute; display:none;">Guardar</button>
</div>

<div id="grid"></div>
<button id="exportBtn">Exportar Colores</button>

<script>
let canvas = document.getElementById('mainCanvas');
let ctx = canvas.getContext('2d');
let img = new Image();
let lupa = document.getElementById('lupa');
let lupaCanvas = document.getElementById('lupaCanvas');
let lupaCtx = lupaCanvas.getContext('2d');
let nameInput = document.getElementById('nameInput');
let colorBox = document.getElementById('colorBox');
let saveBtn = document.getElementById('saveBtn');
let grid = document.getElementById('grid');
let imgUpload = document.getElementById('imgUpload');
let collectionSelect = document.getElementById('collectionSelect');
let newCollectionBtn = document.getElementById('newCollectionBtn');
let sortSelect = document.getElementById('sortSelect');
let exportBtn = document.getElementById('exportBtn');

let collections = {}; 
let currentCollection = "Default";
collections[currentCollection] = [];

collectionSelect.innerHTML = `<option>${currentCollection}</option>`;

function rgbToHex(r,g,b){
  return "#" + ((1 << 24) + (r <<16) + (g<<8) + b).toString(16).slice(1).toUpperCase();
}

function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  let max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0, s=0, l=(max+min)/2;
  if(max!=min){
    let d=max-min;
    s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){
      case r: h=(g-b)/d+(g<b?6:0); break;
      case g: h=(b-r)/d+2; break;
      case b: h=(r-g)/d+4; break;
    }
    h/=6;
  }
  return {h:sanitize(h*360),s:s*100,l:l*100};
}
function sanitize(x){return Math.round(x*100)/100;}

function drawGrid(){
  grid.innerHTML='';
  let sorted = [...collections[currentCollection]];
  let mode = sortSelect.value;
  if(mode==="h_l") sorted.sort((a,b)=>a.h - b.h || a.l - b.l);
  else if(mode==="approx_h_l") sorted.sort((a,b)=>Math.floor(a.h/30) - Math.floor(b.h/30) || a.l - b.l);
  else if(mode==="s_l") sorted.sort((a,b)=>a.s - b.s || a.l - b.l);
  else if(mode==="l_s") sorted.sort((a,b)=>a.l - b.l || a.s - b.s);
  sorted.forEach((c,i)=>{
    let div=document.createElement('div');
    div.className='colorCell';
    div.style.background=c.hex;
    div.innerHTML=`${c.name}<br>${c.hex}`;
    let delBtn = document.createElement('button'); delBtn.textContent='X';
    delBtn.onclick=()=>{collections[currentCollection].splice(collections[currentCollection].indexOf(c),1); drawGrid();}
    div.appendChild(delBtn);
    div.onclick=()=>{generatePalettes(c)};
    grid.appendChild(div);
  });
}

function generatePalettes(color){
  let paletas = [];
  for(let i=0;i<5;i++){
    let pal = collections[currentCollection].sort(()=>0.5-Math.random()).slice(0,5);
    paletas.push(pal);
  }
  console.log("Paletas generadas:",paletas);
  alert("Paletas generadas en consola. Implementa visualización si quieres.");
}

imgUpload.addEventListener('change',e=>{
  let file=e.target.files[0];
  if(!file) return;
  let url=URL.createObjectURL(file);
  img.src=url;
});

img.onload=()=>{
  canvas.width=img.width;
  canvas.height=img.height;
  ctx.drawImage(img,0,0);
};

canvas.addEventListener('mousemove',e=>{
  let rect = canvas.getBoundingClientRect();
  let x = Math.floor(e.clientX - rect.left);
  let y = Math.floor(e.clientY - rect.top);
  if(x<0||y<0||x>=canvas.width||y>=canvas.height) return;
  let pixel = ctx.getImageData(x,y,2,2).data;
  let r = (pixel[0]+pixel[4]+pixel[8]+pixel[12])/4;
  let g = (pixel[1]+pixel[5]+pixel[9]+pixel[13])/4;
  let b = (pixel[2]+pixel[6]+pixel[10]+pixel[14])/4;
  let hex = rgbToHex(Math.round(r),Math.round(g),Math.round(b));
  let hsl = rgbToHsl(r,g,b);
  
  // Lupa
  lupa.style.display='block';
  lupa.style.left=(x-40)+'px';
  lupa.style.top=(y-40)+'px';
  lupaCtx.clearRect(0,0,20,20);
  lupaCtx.drawImage(canvas, x-10, y-10, 20, 20, 0,0,20,20);
  
  // Caja color y nombre
  colorBox.style.display='block';
  colorBox.style.left=(x+50)+'px';
  colorBox.style.top=(y)+'px';
  colorBox.style.background=hex;
  
  nameInput.style.display='block';
  nameInput.style.left=(x+100)+'px';
  nameInput.style.top=(y)+'px';
  nameInput.value='';
  
  saveBtn.style.display='block';
  saveBtn.style.left=(x+210)+'px';
  saveBtn.style.top=(y)+'px';
  
  saveBtn.onclick=()=>{
    if(nameInput.value.trim()==='') return;
    collections[currentCollection].push({hex:hex,name:nameInput.value,h:hsl.h,s:hsl.s,l:hsl.l});
    drawGrid();
    nameInput.value='';
  }
});

newCollectionBtn.onclick=()=>{
  let name=prompt("Nombre de la nueva colección:");
  if(!name) return;
  if(collections[name]) {alert("Ya existe"); return;}
  collections[name]=[];
  let opt=document.createElement('option'); opt.text=name; collectionSelect.add(opt);
  collectionSelect.value=name; currentCollection=name; drawGrid();
}

collectionSelect.addEventListener('change',e=>{
  currentCollection=e.target.value;
  drawGrid();
});

sortSelect.addEventListener('change',drawGrid);

exportBtn.onclick=()=>{
  let data = collections[currentCollection].map(c=>`${c.name},${c.hex}`).join('\n');
  let blob = new Blob([data],{type:'text/plain'});
  let url = URL.createObjectURL(blob);
  let a=document.createElement('a');
  a.href=url; a.download=`${currentCollection}.txt`; a.click();
}

</script>

</body>
</html>
