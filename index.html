 <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de colores PWA - Lupa + Selecci√≥n m√∫ltiple</title>
<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:16px; background:#f5f5f5; }
h1{ font-size:20px; margin-bottom:12px; }
.box{ background:#fff; padding:12px; border-radius:8px; margin-bottom:16px;}
canvas{ display:block; width:100%; max-width:700px; border:1px solid #ccc; touch-action:none; }
.lupa{ position:absolute; width:100px; height:100px; border:2px solid #333; border-radius:50%; overflow:hidden; display:none; pointer-events:none; z-index:1000; }
.lupa canvas{ position:absolute; width:200px; height:200px; }
.lupa-dot{ position:absolute; width:4px; height:4px; background:red; border-radius:50%; top:48px; left:48px; pointer-events:none; }
.floating-input{ position:absolute; background:#fff; border:1px solid #333; padding:4px; border-radius:4px; display:none; z-index:1001; display:flex; align-items:center; gap:4px;}
.floating-color-box{ width:24px; height:24px; border:1px solid #000; border-radius:4px; }
button{ padding:6px 10px; margin-right:4px; margin-bottom:4px; }
.collection-select{ margin-bottom:8px; }
.family-title{ font-weight:bold; margin-top:12px; }
.grid{ display:grid; grid-template-columns:repeat(10,1fr); gap:8px; margin-bottom:16px; }
.grid-cell{ background:#fff; border:1px solid #ccc; border-radius:4px; text-align:center; padding:4px; position:relative; }
.color-box{ width:40px; height:40px; margin:auto; border:1px solid #000; border-radius:4px; }
.cell-buttons{ display:flex; justify-content:center; gap:2px; margin-top:2px; }
.cell-buttons button{ padding:2px 4px; font-size:10px; }
.scrollable{ max-height:400px; overflow-y:auto; border:1px solid #ccc; padding:4px; border-radius:4px; background:#fafafa; }
.palette-box{ width:30px; height:30px; display:inline-block; margin:2px; border-radius:4px; border:1px solid #000;}
.multi-selected{ display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; border:1px dashed #333; padding:4px; border-radius:4px; background:#fafafa;}
.multi-color-box{ width:30px; height:30px; border:1px solid #000; border-radius:4px; position:relative; display:flex; align-items:center; justify-content:center; font-size:16px; cursor:pointer;}
.multi-color-box button{ position:absolute; top:0; right:0; padding:0; margin:0; border:none; background:rgba(255,255,255,0.7); cursor:pointer; border-radius:50%;}
</style>
</head>
<body>

<h1>Gestor de colores - Lupa + Selecci√≥n m√∫ltiple</h1>

<div class="box">
  <label>Colecci√≥n: 
    <select id="collectionSelect" class="collection-select"></select>
    <button id="newCollectionBtn">Nueva colecci√≥n</button>
  </label>
</div>

<div class="box" style="position:relative;">
  <input type="file" id="imageInput" accept="image/png, image/jpeg">
  <canvas id="canvas"></canvas>

  <div class="lupa" id="lupa">
    <canvas id="lupaCanvas"></canvas>
    <div class="lupa-dot"></div>
  </div>
</div>

<div class="box">
  <p>Introduce nombres o n√∫meros de los colores seleccionados separados por <strong>comas</strong> (ej: 23,A12,Rojo pastel)</p>
  <input type="text" id="multiNumbers" placeholder="23,A12,Rojo pastel...">
  <button id="saveMultiBtn">Guardar selecci√≥n</button>
  <div id="multiSelected" class="multi-selected"></div>
</div>

<div class="box">
  <div class="row-buttons">
    <button onclick="sortAll('h')">Ordenar por matiz</button>
    <button onclick="sortAll('s')">Ordenar por saturaci√≥n</button>
    <button onclick="sortAll('l')">Ordenar por luminosidad</button>
    <button onclick="exportNumbers()">Exportar n√∫meros</button>
  </div>
  <div class="scrollable" id="collectionsContainer"></div>
</div>

<div class="box">
  <h2>Paletas del color seleccionado</h2>
  <div id="paletteContainer"></div>
</div>

<script>
const imageInput=document.getElementById("imageInput");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const lupaDiv=document.getElementById("lupa");
const lupaCanvas=document.getElementById("lupaCanvas");
const lupaCtx=lupaCanvas.getContext("2d");
const collectionSelect=document.getElementById("collectionSelect");
const newCollectionBtn=document.getElementById("newCollectionBtn");
const collectionsContainer=document.getElementById("collectionsContainer");
const paletteContainer=document.getElementById("paletteContainer");
const saveMultiBtn=document.getElementById("saveMultiBtn");
const multiNumbersInput=document.getElementById("multiNumbers");
const multiSelectedDiv=document.getElementById("multiSelected");

let currentImage=null, currentCollection=null;
let multiColors=[];

const families=[
  {name:"Rojos", min:345, max:15},
  {name:"Naranjas", min:16, max:45},
  {name:"Amarillos", min:46, max:75},
  {name:"Verdes", min:76, max:165},
  {name:"Cian", min:166, max:195},
  {name:"Azules", min:196, max:255},
  {name:"Violetas", min:256, max:285},
  {name:"Magenta", min:286, max:344},
];

let collections=JSON.parse(localStorage.getItem("colorCollections")||"{}");

function updateCollectionSelect(){
  collectionSelect.innerHTML="";
  for(let c in collections){
    const opt=document.createElement("option");
    opt.value=c; opt.text=c;
    collectionSelect.appendChild(opt);
  }
  if(collectionSelect.options.length>0){
    currentCollection=collectionSelect.value;
    renderCollection();
  }
}

newCollectionBtn.addEventListener("click", ()=>{
  const name=prompt("Nombre de la nueva colecci√≥n:");
  if(name && !collections[name]){
    collections[name]={};
    saveCollections();
    updateCollectionSelect();
    collectionSelect.value=name;
    currentCollection=name;
    renderCollection();
  }
});

collectionSelect.addEventListener("change",()=>{
  currentCollection=collectionSelect.value;
  renderCollection();
});

function saveCollections(){
  localStorage.setItem("colorCollections", JSON.stringify(collections));
}

// ===== Carga de imagen =====
imageInput.addEventListener("change", ()=>{
  const file=imageInput.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      const maxWidth=800, maxHeight=600;
      let w=img.naturalWidth, h=img.naturalHeight;
      const scale=Math.min(maxWidth/w, maxHeight/h,1);
      canvas.width=w*scale;
      canvas.height=h*scale;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      currentImage=img;
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
});

// ===== Funciones de color ======
function rgbToHex(r,g,b){ return "#" + [r,g,b].map(v=>v.toString(16).padStart(2,"0")).join(""); }
function hexToHSL(H){
  let r=parseInt(H.substring(1,3),16)/255;
  let g=parseInt(H.substring(3,5),16)/255;
  let b=parseInt(H.substring(5,7),16)/255;
  let cmin=Math.min(r,g,b), cmax=Math.max(r,g,b), delta=cmax-cmin;
  let h=0,s=0,l=(cmax+cmin)/2;
  if(delta!==0){
    if(cmax===r) h=((g-b)/delta)%6;
    else if(cmax===g) h=((b-r)/delta)+2;
    else h=((b-g)/delta)+4;
  }
  h=Math.round(h*60); if(h<0) h+=360;
  s=delta===0?0:delta/(1-Math.abs(2*l-1));
  s=Math.round(s*100); l=Math.round(l*100);
  return {h,s,l};
}
function getFamily(h){
  for(let f of families){
    if(f.min>f.max){ if(h>=f.min || h<=f.max) return f.name; }
    else if(h>=f.min && h<=f.max) return f.name;
  }
  return "Otros";
}

// ===== Lupa y selecci√≥n m√∫ltiple =====
function addMultiColor(x,y){
  if(!currentImage) return;
  const rect=canvas.getBoundingClientRect();
  const scaleX=canvas.width/rect.width;
  const scaleY=canvas.height/rect.height;
  const clickX=Math.floor((x-rect.left)*scaleX);
  const clickY=Math.floor((y-rect.top)*scaleY);

  const pixel=ctx.getImageData(clickX,clickY,1,1).data;
  const hex=rgbToHex(pixel[0],pixel[1],pixel[2]);

  if(multiColors.find(c=>c.hex===hex)) return;
  multiColors.push({hex});
  renderMultiSelected();
  generatePalettes(hex);
}

// Mostrar lupa
function moveLupa(x,y){
  if(!currentImage) return;
  lupaDiv.style.display="block";
  const rect=canvas.getBoundingClientRect();
  const size=lupaDiv.offsetWidth;
  lupaDiv.style.left=(x-size/2)+"px";
  lupaDiv.style.top=(y-size/2)+"px";

  const scaleX=canvas.width/rect.width;
  const scaleY=canvas.height/rect.height;
  const cx=Math.floor((x-rect.left)*scaleX);
  const cy=Math.floor((y-rect.top)*scaleY);

  const zoom=2;
  const lw=lupaCanvas.width, lh=lupaCanvas.height;
  const sx=cx-lw/(2*zoom);
  const sy=cy-lh/(2*zoom);
  lupaCtx.clearRect(0,0,lw,lh);
  lupaCtx.drawImage(canvas,sx,sy,lw/zoom,lh/zoom,0,0,lw,lh);
}

canvas.addEventListener("mousedown",(e)=>{ addMultiColor(e.clientX,e.clientY); });
canvas.addEventListener("mousemove",(e)=>{ if(e.buttons){ moveLupa(e.clientX,e.clientY); addMultiColor(e.clientX,e.clientY); } });
canvas.addEventListener("mouseup",(e)=>{ moveLupa(e.clientX,e.clientY); lupaDiv.style.display="none"; });

canvas.addEventListener("touchstart",(e)=>{ e.preventDefault(); const t=e.touches[0]; moveLupa(t.clientX,t.clientY); addMultiColor(t.clientX,t.clientY); });
canvas.addEventListener("touchmove",(e)=>{ e.preventDefault(); const t=e.touches[0]; moveLupa(t.clientX,t.clientY); addMultiColor(t.clientX,t.clientY); });
canvas.addEventListener("touchend",(e)=>{ lupaDiv.style.display="none"; });

function renderMultiSelected(){
  multiSelectedDiv.innerHTML="";
  multiColors.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="multi-color-box";
    div.style.background=c.hex;

    const delBtn=document.createElement("button");
    delBtn.textContent="√ó";
    delBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      multiColors.splice(i,1);
      renderMultiSelected();
    });

    div.appendChild(delBtn);
    multiSelectedDiv.appendChild(div);
  });
}

// ===== Guardar selecci√≥n =====
saveMultiBtn.addEventListener("click",()=>{
  if(!currentCollection || multiColors.length===0) return alert("Selecciona colores y colecci√≥n");
  const numbers=multiNumbersInput.value.split(",").map(s=>s.trim());
  if(numbers.length!==multiColors.length) return alert("Introduce el mismo n√∫mero de nombres que colores seleccionados");

  multiColors.forEach((c,i)=>{
    const hsl=hexToHSL(c.hex);
    const family=getFamily(hsl.h);
    if(!collections[currentCollection][family]) collections[currentCollection][family]=[];
    collections[currentCollection][family].push({
      number:numbers[i],
      hex:c.hex,
      h:hsl.h,
      s:hsl.s,
      l:hsl.l
    });
  });
  saveCollections();
  renderCollection();
  multiColors=[]; multiNumbersInput.value=""; renderMultiSelected();
});

// ===== Render colecci√≥n =====
function renderCollection(){
  collectionsContainer.innerHTML="";
  if(!currentCollection) return;
  const data=collections[currentCollection];
  for(let f of families){
    if(!data[f.name] || data[f.name].length===0) continue;
    const title=document.createElement("div");
    title.className="family-title";
    title.textContent=f.name;
    collectionsContainer.appendChild(title);

    const grid=document.createElement("div");
    grid.className="grid";
    data[f.name].forEach((c,index)=>{
      const cell=document.createElement("div");
      cell.className="grid-cell";
      cell.innerHTML=`<div class="color-box" style="background:${c.hex}"></div><div>${c.number}</div>
      <div class="cell-buttons">
        <button onclick="editColor('${f.name}',${index})">‚úé</button>
        <button onclick="deleteColor('${f.name}',${index})">üóë</button>
      </div>`;
      cell.dataset.h=c.h; cell.dataset.s=c.s; cell.dataset.l=c.l; cell.dataset.number=c.number;
      grid.appendChild(cell);
    });
    collectionsContainer.appendChild(grid);
  }
}

// ===== Editar/Borrar =====
window.editColor=(family,index)=>{
  const c=collections[currentCollection][family][index];
  const newNum=prompt("Editar n√∫mero/nombre",c.number);
  if(newNum){ c.number=newNum; saveCollections(); renderCollection(); }
}
window.deleteColor=(family,index)=>{
  if(confirm("Eliminar este color?")){
    collections[currentCollection][family].splice(index,1);
    saveCollections(); renderCollection();
  }
}

// ===== Ordenar =====
function sortAll(prop){
  if(!currentCollection) return;
  const data=collections[currentCollection];
  for(let f in data) data[f].sort((a,b)=>a[prop]-b[prop]);
  saveCollections();
  renderCollection();
}

// ===== Exportar n√∫meros =====
function exportNumbers(){
  if(!currentCollection) return;
  let numbers=[];
  const data=collections[currentCollection];
  for(let f of families){
    if(!data[f.name]) continue;
    numbers.push(...data[f.name].map(c=>c.number));
  }
  const blob=new Blob([numbers.join("\n")],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=currentCollection+"_numbers.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== Paletas =====
function generatePalettes(hex){
  paletteContainer.innerHTML="";
  const hsl=hexToHSL(hex);
  for(let i=0;i<5;i++){
    let h=(hsl.h + i*30)%360; 
    let s=Math.min(100,hsl.s+ (i%2===0?10:-10));
    let l=Math.min(100,hsl.l+ (i%2===0?10:-10));
    let palHex=hslToHex(h,s,l);
    const div=document.createElement("div");
    div.className="palette-box";
    div.style.background=palHex;
    paletteContainer.appendChild(div);
  }
}

function hslToHex(h,s,l){
  s/=100; l/=100;
  let c=(1-Math.abs(2*l-1))*s;
  let x=c*(1-Math.abs((h/60)%2-1));
  let m=l-c/2;
  let r=0,g=0,b=0;
  if(h<60){ r=c; g=x; b=0;}
  else if(h<120){ r=x; g=c; b=0;}
  else if(h<180){ r=0; g=c; b=x;}
  else if(h<240){ r=0; g=x; b=c;}
  else if(h<300){ r=x; g=0; b=c;}
  else{ r=c; g=0; b=x;}
  r=Math.round((r+m)*255); g=Math.round((g+m)*255); b=Math.round((b+m)*255);
  return rgbToHex(r,g,b);
}

updateCollectionSelect();
</script>
</body>
</html>
