 <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de colores - PWA iPad</title>
<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin:16px; background:#f5f5f5; }
h1{ font-size:20px; margin-bottom:12px; }
.box{ background:#fff; padding:12px; border-radius:8px; margin-bottom:16px;}
canvas{ display:block; width:100%; max-width:700px; border:1px solid #ccc; touch-action:none; }
.lupa{ position:absolute; width:80px; height:80px; border:2px solid #333; border-radius:50%; overflow:hidden; display:none; pointer-events:none; z-index:1000; }
.lupa canvas{ position:absolute; width:160px; height:160px; }
.lupa-dot{ position:absolute; width:4px; height:4px; background:red; border-radius:50%; top:38px; left:38px; pointer-events:none; }
.floating-input{ position:absolute; background:#fff; border:1px solid #333; padding:4px; border-radius:4px; display:none; z-index:1001; display:flex; align-items:center; gap:4px;}
.floating-color-box{ width:24px; height:24px; border:1px solid #000; border-radius:4px; }
button{ padding:6px 10px; margin-right:4px; margin-bottom:4px; }
.collection-select{ margin-bottom:8px; }
.family-title{ font-weight:bold; margin-top:12px; }
.grid{ display:grid; grid-template-columns:repeat(10,1fr); gap:8px; margin-bottom:16px; }
.grid-cell{ background:#fff; border:1px solid #ccc; border-radius:4px; text-align:center; padding:4px; position:relative; }
.color-box{ width:40px; height:40px; margin:auto; border:1px solid #000; border-radius:4px; }
.cell-buttons{ display:flex; justify-content:center; gap:2px; margin-top:2px; }
.cell-buttons button{ padding:2px 4px; font-size:10px; }
.scrollable{ max-height:400px; overflow-y:auto; border:1px solid #ccc; padding:4px; border-radius:4px; background:#fafafa; }
</style>
</head>
<body>

<h1>Gestor de colores - PWA iPad</h1>

<div class="box">
  <label>Colecci√≥n: 
    <select id="collectionSelect" class="collection-select"></select>
    <button id="newCollectionBtn">Nueva colecci√≥n</button>
  </label>
</div>

<div class="box">
  <input type="file" id="imageInput" accept="image/png, image/jpeg">
  <canvas id="canvas"></canvas>

  <div class="lupa" id="lupa">
    <canvas id="lupaCanvas"></canvas>
    <div class="lupa-dot"></div>
  </div>

  <div class="floating-input" id="floatingInput">
    <div class="floating-color-box" id="floatingColorBox"></div>
    <input type="text" id="colorNumber" placeholder="N√∫mero/Nombre">
    <button id="saveColorBtn">Guardar</button>
  </div>
</div>

<div class="box">
  <div class="row-buttons">
    <button onclick="sortAll('h')">Ordenar por matiz</button>
    <button onclick="sortAll('s')">Ordenar por saturaci√≥n</button>
    <button onclick="sortAll('l')">Ordenar por luminosidad</button>
    <button onclick="exportNumbers()">Exportar n√∫meros</button>
  </div>
  <div class="scrollable" id="collectionsContainer"></div>
</div>

<script>
const imageInput=document.getElementById("imageInput");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const lupaDiv=document.getElementById("lupa");
const lupaCanvas=document.getElementById("lupaCanvas");
const lupaCtx=lupaCanvas.getContext("2d");
const floatingInput=document.getElementById("floatingInput");
const colorNumberInput=document.getElementById("colorNumber");
const floatingColorBox=document.getElementById("floatingColorBox");
const saveColorBtn=document.getElementById("saveColorBtn");
const collectionSelect=document.getElementById("collectionSelect");
const newCollectionBtn=document.getElementById("newCollectionBtn");
const collectionsContainer=document.getElementById("collectionsContainer");

let currentImage=null, currentColor=null, clickX=0, clickY=0, currentCollection=null;

const families=[
  {name:"Rojos", min:345, max:15},
  {name:"Naranjas", min:16, max:45},
  {name:"Amarillos", min:46, max:75},
  {name:"Verdes", min:76, max:165},
  {name:"Cian", min:166, max:195},
  {name:"Azules", min:196, max:255},
  {name:"Violetas", min:256, max:285},
  {name:"Magenta", min:286, max:344},
];

let collections=JSON.parse(localStorage.getItem("colorCollections")||"{}");

function updateCollectionSelect(){
  collectionSelect.innerHTML="";
  for(let c in collections){
    const opt=document.createElement("option");
    opt.value=c; opt.text=c;
    collectionSelect.appendChild(opt);
  }
  if(collectionSelect.options.length>0){
    currentCollection=collectionSelect.value;
    renderCollection();
  }
}

newCollectionBtn.addEventListener("click", ()=>{
  const name=prompt("Nombre de la nueva colecci√≥n:");
  if(name && !collections[name]){
    collections[name]={};
    saveCollections();
    updateCollectionSelect();
    collectionSelect.value=name;
    currentCollection=name;
    renderCollection();
  }
});

collectionSelect.addEventListener("change",()=>{
  currentCollection=collectionSelect.value;
  renderCollection();
});

function saveCollections(){
  localStorage.setItem("colorCollections", JSON.stringify(collections));
}

// ===== Carga de imagen =====
imageInput.addEventListener("change", ()=>{
  const file=imageInput.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      const maxWidth=800, maxHeight=600;
      let w=img.naturalWidth, h=img.naturalHeight;
      const scale=Math.min(maxWidth/w, maxHeight/h,1);
      canvas.width=w*scale;
      canvas.height=h*scale;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      currentImage=img;
    };
    img.onerror=function(){ alert("Error al cargar la imagen. Intenta exportarla de nuevo como PNG/JPG."); };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
});

// ===== Funciones de color ======
function rgbToHex(r,g,b){ return "#" + [r,g,b].map(v=>v.toString(16).padStart(2,"0")).join(""); }
function hexToHSL(H){
  let r=parseInt(H.substring(1,3),16)/255;
  let g=parseInt(H.substring(3,5),16)/255;
  let b=parseInt(H.substring(5,7),16)/255;
  let cmin=Math.min(r,g,b), cmax=Math.max(r,g,b), delta=cmax-cmin;
  let h=0,s=0,l=(cmax+cmin)/2;
  if(delta!==0){
    if(cmax===r) h=((g-b)/delta)%6;
    else if(cmax===g) h=((b-r)/delta)+2;
    else h=((r-g)/delta)+4;
  }
  h=Math.round(h*60); if(h<0) h+=360;
  s=delta===0?0:delta/(1-Math.abs(2*l-1));
  s=Math.round(s*100); l=Math.round(l*100);
  return {h,s,l};
}
function getFamily(h){
  for(let f of families){
    if(f.min>f.max){ if(h>=f.min || h<=f.max) return f.name; }
    else if(h>=f.min && h<=f.max) return f.name;
  }
  return "Otros";
}

// ===== Lupa y floating input =====
function updateLupaAndInput(x,y,screenX,screenY){
  if(!currentImage) return;
  const rect=canvas.getBoundingClientRect();
  const scaleX=canvas.width/rect.width;
  const scaleY=canvas.height/rect.height;
  clickX=Math.floor((x-rect.left)*scaleX);
  clickY=Math.floor((y-rect.top)*scaleY);

  const pixel=ctx.getImageData(clickX,clickY,1,1).data;
  currentColor=rgbToHex(pixel[0],pixel[1],pixel[2]);

  // Lupa
  const lupaSize=80, zoom=2;
  const srcSize=lupaSize/zoom;
  const sx=Math.max(0,clickX-srcSize/2), sy=Math.max(0,clickY-srcSize/2);
  lupaCtx.clearRect(0,0,lupaCanvas.width,lupaCanvas.height);
  lupaCtx.drawImage(canvas,sx,sy,srcSize,srcSize,0,0,lupaCanvas.width,lupaCanvas.height);
  lupaDiv.style.left=(screenX-lupaSize/2)+"px";
  lupaDiv.style.top=(screenY-lupaSize/2)+"px";
  lupaDiv.style.display="block";

  // Floating input
  floatingColorBox.style.background=currentColor;
  let inputLeft = screenX + 10;
  let inputTop = screenY - floatingInput.offsetHeight/2;
  if(inputLeft + floatingInput.offsetWidth > window.innerWidth) inputLeft = screenX - floatingInput.offsetWidth - 10;
  if(inputTop + floatingInput.offsetHeight > window.innerHeight) inputTop = window.innerHeight - floatingInput.offsetHeight - 10;
  if(inputTop < 0) inputTop = 10;

  floatingInput.style.left=inputLeft + "px";
  floatingInput.style.top=inputTop + "px";
  floatingInput.style.display="flex";

  // Forzamos focus en iPad para mostrar input
  setTimeout(()=>{ colorNumberInput.focus(); },50);
}

canvas.addEventListener("touchstart",(e)=>{ e.preventDefault(); const t=e.touches[0]; updateLupaAndInput(t.clientX,t.clientY,t.pageX,t.pageY); });
canvas.addEventListener("touchmove",(e)=>{ e.preventDefault(); const t=e.touches[0]; updateLupaAndInput(t.clientX,t.clientY,t.pageX,t.pageY); });
canvas.addEventListener("touchend",(e)=>{ e.preventDefault(); });

// ===== Guardar color =====
saveColorBtn.addEventListener("click",()=>{
  const number=colorNumberInput.value.trim();
  if(!number || !currentColor || !currentCollection) { alert("Introduce un n√∫mero y toca un color"); return; }
  const hsl=hexToHSL(currentColor);
  const family=getFamily(hsl.h);
  if(!collections[currentCollection][family]) collections[currentCollection][family]=[];
  const colorObj={number:number, hex:currentColor, h:hsl.h,s:hsl.s,l:hsl.l};
  collections[currentCollection][family].push(colorObj);
  saveCollections();
  renderCollection();
  colorNumberInput.value="";
  floatingInput.style.display="none";
  lupaDiv.style.display="none";
});

// ===== Render colecci√≥n =====
function renderCollection(){
  collectionsContainer.innerHTML="";
  if(!currentCollection) return;
  const data=collections[currentCollection];
  for(let f of families){
    if(!data[f.name] || data[f.name].length===0) continue;
    const title=document.createElement("div");
    title.className="family-title";
    title.textContent=f.name;
    collectionsContainer.appendChild(title);

    const grid=document.createElement("div");
    grid.className="grid";
    data[f.name].forEach((c,index)=>{
      const cell=document.createElement("div");
      cell.className="grid-cell";
      cell.innerHTML=`<div class="color-box" style="background:${c.hex}"></div><div>${c.number}</div>
      <div class="cell-buttons">
        <button onclick="editColor('${f.name}',${index})">‚úé</button>
        <button onclick="deleteColor('${f.name}',${index})">üóë</button>
      </div>`;
      cell.dataset.h=c.h; cell.dataset.s=c.s; cell.dataset.l=c.l; cell.dataset.number=c.number;
      grid.appendChild(cell);
    });
    collectionsContainer.appendChild(grid);
  }
}

// ===== Editar/Borrar =====
window.editColor=(family,index)=>{
  const c=collections[currentCollection][family][index];
  const newNum=prompt("Editar n√∫mero/nombre",c.number);
  if(newNum){ c.number=newNum; saveCollections(); renderCollection(); }
}
window.deleteColor=(family,index)=>{
  if(confirm("Eliminar este color?")){
    collections[currentCollection][family].splice(index,1);
    saveCollections(); renderCollection();
  }
}

// ===== Ordenar =====
function sortAll(prop){
  if(!currentCollection) return;
  const data=collections[currentCollection];
  for(let f in data) data[f].sort((a,b)=>a[prop]-b[prop]);
  saveCollections();
  renderCollection();
}

// ===== Exportar n√∫meros =====
function exportNumbers(){
  if(!currentCollection) return;
  let numbers=[];
  const data=collections[currentCollection];
  for(let f of families){
    if(!data[f.name]) continue;
    numbers.push(...data[f.name].map(c=>c.number));
  }
  const blob=new Blob([numbers.join("\n")],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=currentCollection+"_numbers.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== Inicializar =====
updateCollectionSelect();
</script>

</body>
</html>
