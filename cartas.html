<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selector de Colores de Cartas - PWA Guardada</title>

<meta name="theme-color" content="#ffffff">
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAO0lEQVR4AWP4//8/AzGACyAcTMSfC/5NlwC0IicH3P4Di6EGIMKBwFRIhNhJxCvUAAAAASUVORK5CYII=">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAO0lEQVR4AWP4//8/AzGACyAcTMSfC/5NlwC0IicH3P4Di6EGIMKBwFRIhNhJxCvUAAAAASUVORK5CYII=">
<link rel="manifest" href="data:application/manifest+json,{"short_name":"ColoresCartas","name":"Selector de Colores de Cartas","start_url":"./","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[{"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAO0lEQVR4AWP4//8/AzGACyAcTMSfC/5NlwC0IicH3P4Di6EGIMKBwFRIhNhJxCvUAAAAASUVORK5CYII=","sizes":"32x32","type":"image/png"}]}">

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
canvas { border: 1px solid #ccc; display: block; margin-bottom: 10px; cursor: crosshair; }
#colorPreview { display: inline-block; width: 30px; height: 30px; vertical-align: middle; border: 1px solid #000; margin-left: 10px; }
input[type="text"] { width: 100px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
.colorBox { width: 20px; height: 20px; display: inline-block; border: 1px solid #000; }
button.sortBtn { margin-right: 5px; }
#pixelZoom { border:1px solid #000; width:100px; height:100px; image-rendering: pixelated; display:inline-block; margin-left:10px; vertical-align:middle; }
#coords { margin-left:10px; font-weight:bold; }
</style>
</head>
<body>

<h2>Selector de Colores de Cartas - PWA con Guardado</h2>

<input type="file" id="imageInput" accept="image/*"><br><br>
<canvas id="canvas"></canvas>
<span id="colorHEX">#FFFFFF</span>
<div id="colorPreview"></div>
<span id="coords">(x: -, y: -)</span>
<canvas id="pixelZoom" width="100" height="100"></canvas>

<h3>Registrar color</h3>
<input type="text" id="cardNumber" placeholder="Número/ID">
<button id="saveColorBtn">Guardar color</button>

<h3>Tabla de colores</h3>
<div>
  <button class="sortBtn" id="sortHue">Ordenar por matiz</button>
  <button class="sortBtn" id="sortSaturation">Ordenar por saturación</button>
  <button class="sortBtn" id="sortLightness">Ordenar por luminosidad</button>
</div>
<table id="colorTable">
  <thead>
    <tr>
      <th>Número de carta</th>
      <th>HEX</th>
      <th>Color</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
/* --- PWA Service Worker embebido --- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
    self.addEventListener('install', e => e.waitUntil(caches.open('v1').then(c => c.addAll(['./']))));
    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
  `], {type:'application/javascript'})));
}

/* --- App --- */
const canvas = document.getElementById('canvas');
const zoomCanvas = document.getElementById('pixelZoom');
const zoomCtx = zoomCanvas.getContext('2d');
const ctx = canvas.getContext('2d');
const imageInput = document.getElementById('imageInput');
const colorHEXSpan = document.getElementById('colorHEX');
const colorPreview = document.getElementById('colorPreview');
const coordsSpan = document.getElementById('coords');
const cardNumberInput = document.getElementById('cardNumber');
const saveColorBtn = document.getElementById('saveColorBtn');
const tableBody = document.querySelector('#colorTable tbody');

let currentColor = '#FFFFFF';
let colorData = [];
let img = new Image();

function rgbToHex(r,g,b){ return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join(''); }
function hexToHSL(H){
    let r=0,g=0,b=0;
    if(H.length==7){ r=parseInt(H.slice(1,3),16)/255; g=parseInt(H.slice(3,5),16)/255; b=parseInt(H.slice(5,7),16)/255; }
    let cmin=Math.min(r,g,b), cmax=Math.max(r,g,b), delta=cmax-cmin, h=0, s=0, l=0;
    if(delta==0) h=0;
    else if(cmax==r) h=((g-b)/delta)%6;
    else if(cmax==g) h=(b-r)/delta+2;
    else h=(r-g)/delta+4;
    h=Math.round(h*60); if(h<0) h+=360;
    l=(cmax+cmin)/2;
    s=delta==0?0:delta/(1-Math.abs(2*l-1));
    s=+(s*100).toFixed(1);
    l=+(l*100).toFixed(1);
    return {h,s,l};
}

/* --- Cargar imagen --- */
imageInput.addEventListener('change', function(){
    const file = this.files[0];
    if(!file) return;
    img.onload = function(){ canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img,0,0); }
    img.src = URL.createObjectURL(file);
});

/* --- Capturar color al hacer clic --- */
canvas.addEventListener('click', function(e){
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor(e.clientX - rect.left);
    const y = Math.floor(e.clientY - rect.top);
    const pixel = ctx.getImageData(x,y,1,1).data;
    currentColor = rgbToHex(pixel[0],pixel[1],pixel[2]);
    colorHEXSpan.textContent = currentColor;
    colorPreview.style.backgroundColor = currentColor;
    coordsSpan.textContent = `(x: ${x}, y: ${y})`;

    zoomCtx.clearRect(0,0,zoomCanvas.width,zoomCanvas.height);
    zoomCtx.imageSmoothingEnabled = false;
    zoomCtx.drawImage(canvas, x-5, y-5, 10, 10, 0, 0, zoomCanvas.width, zoomCanvas.height);
});

/* --- Render tabla --- */
function renderTable(){
    tableBody.innerHTML = '';
    for(let entry of colorData){
        const tr = document.createElement('tr');
        const tdNumber = document.createElement('td'); tdNumber.textContent = entry.number;
        const tdHex = document.createElement('td'); tdHex.textContent = entry.hex;
        const tdColor = document.createElement('td'); 
        const divColor = document.createElement('div');
        divColor.className = 'colorBox'; divColor.style.backgroundColor = entry.hex;
        tdColor.appendChild(divColor);
        tr.appendChild(tdNumber); tr.appendChild(tdHex); tr.appendChild(tdColor);
        tableBody.appendChild(tr);
    }
    localStorage.setItem('colorData', JSON.stringify(colorData));
}

/* --- Guardar color --- */
saveColorBtn.addEventListener('click', function(){
    const number = cardNumberInput.value.trim();
    if(!number) { alert("Escribe un número o ID de carta."); return; }
    const hsl = hexToHSL(currentColor);
    colorData.push({number, hex: currentColor, h: hsl.h, s: hsl.s, l: hsl.l});
    renderTable();
    cardNumberInput.value = '';
});

/* --- Ordenar tabla --- */
document.getElementById('sortHue').addEventListener('click', ()=>{ colorData.sort((a,b)=>a.h-b.h); renderTable(); });
document.getElementById('sortSaturation').addEventListener('click', ()=>{ colorData.sort((a,b)=>a.s-b.s); renderTable(); });
document.getElementById('sortLightness').addEventListener('click', ()=>{ colorData.sort((a,b)=>a.l-b.l); renderTable(); });

/* --- Cargar datos guardados al iniciar --- */
window.addEventListener('load', ()=>{
    const saved = localStorage.getItem('colorData');
    if(saved) { colorData = JSON.parse(saved); renderTable(); }
});
</script>

</body>
</html>